---
title: "Golang ã§ã® DI ã‚’ã„ã„æ„Ÿã˜ã«è§£æ±ºã™ã‚‹DI Containerã‚’ä½œã£ã¦ã¿ãŸ"
type: "tech"
topics: ["go","di","ãƒ¡ãƒ¢","ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°","web"]
published: true
emoji: "ğŸ’¡"
published_at: 2022-04-02 12:00
---
2021å¹´4æœˆã‹ã‚‰ç¾å ´ã‚’ç§»å‹•ã—ãŸã®ã§ã™ãŒã€ä»Šã®ç¾å ´ã® DI ãŒçµæ§‹è¾›ã„ã“ã¨ã«ãªã£ã¦ã„ã‚‹ã®ã§
ã„ã„æ„Ÿã˜ã« DI ã™ã‚‹æ–¹æ³•ã‚’è€ƒãˆã¦ã¿ã¾ã—ãŸã€‚

## ã‚ã‚‹ã‚ã‚‹DIï¼ˆè¾›ã„ã‚„ã¤

ã‚ˆãã‚ã‚‹ã€è‚¥å¤§åŒ–ã—ã¦ã„ã DI ã®ä¾‹ã§ã™ã€‚
Usecase ã¨ Repository ã‚’ä½œæˆã—ã€DI ã—ã¦ã¿ã¾ã™ã€‚

`/usecase/usecase.go`

```go
package usecase

import (
 repo "github.com/tkyatg/ditest-api/repository"
)
type (
 usecase struct {
  repo repo.Repository
 }
 Usecase interface {
  Hello() string
 }
)
func NewUsecase(repo repo.Repository) Usecase {
 return &usecase{
  repo,
 }
}
func (t *usecase) Hello() string {
 return t.repo.Hello()
}
```

- `/repository/repository.go`

```go
package repository

type (
 Repository interface {
  Hello() string
 }
 repository struct{}
)

func NewRepository() Repository {
 return &repository{}
}

func (t *repository) Hello() string {
 return "hello from repository"
}
```

ä¸Šè¨˜ã®ã‚ˆã†ãªå®Ÿè£…ã‚’ã—ã¦ã„ã‚‹å ´åˆ
Repository ã®`Hello()`ã‚’å‘¼ã³å‡ºã—ãŸã„éš›ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```go
repo := repository.NewRepository()
uc := usecase.NewUsecase(repo)
uc.Hello() // usecaseã®ä¸­ã§repoã®å‡¦ç†ã‚’å‘¼ã‚“ã§ã„ã‚‹
```

ã“ã®å‘¼ã³æ–¹ã‚’ã™ã‚‹å ´åˆã€ã‚µãƒ¼ãƒ“ã‚¹ãŒå¤§ãããªã‚‹ã»ã©ã« DI ãŒè¾›ããªã£ã¦ã„ãã¾ã™ã€‚
ä¾‹ãˆã°å¤–éƒ¨ SDK ã‚’ä½¿ã†å ´åˆã‚„ã€ãã®ä»–è«¸ã€…è¿½åŠ ã—ã¦ã„ãã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ãã¾ã™ã€‚

```go
env := env.NewEnv()
awsClient := aws.NewClient(env)
gcpClient := gcp.NewClient(env)
sendgridClient := sendgrid.NewClient(env)
da := dataAccessor.NewDataAccessor(env)
repo := repository.NewRepository(da, awsClient, gcpClient, sendgridClient)
uc := usecase.NewUsecase(env, repo)
uc.Hello()
```

## DIã‚’æ”¹å–„ã—ã¦ã¿ã‚‹

ä»Šå›ä½œã£ãŸ DI ãƒ„ãƒ¼ãƒ«ã¯ã„ã‚ã‚†ã‚‹ **DI Container** ã¨ã„ã†ã‚„ã¤ã§ã™ã€‚
DI ã‚’è‡ªå‹•çš„ã«è§£æ±ºã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

Usecase ã¨ Repository ã‚’ DI Container ã«ç™»éŒ²ã™ã‚‹

```go
container := dicontainer.NewContainer()
if err := container.Register(repository.NewRepository); err != nil {
 log.Fatal(err)
}
if err := container.Register(usecase.NewUsecase); err != nil {
 log.Fatal(err)
}
```

DI Container ã«ç™»éŒ²ã—ãŸ Usecase ã®`Hello()`ã‚’å‘¼ã³å‡ºã—ã¦ã¿ã‚‹

```go
if err := container.Invoke(func(
 uc usecase.Usecase,
) error {
 uc.Hello()
 return nil
}); err != nil {
 log.Fatal(err)
}
```

ã“ã®æ–¹æ³•ã§ã‚ã‚Œã°ã€DI ã™ã‚‹ Function ãŒå¢—ãˆãŸã‚Šã€å¼•æ•°ã¨ãªã‚‹ Interface ãŒå¢—ãˆã¦ã‚‚å‘¼ã³å‡ºã—æ™‚ã‚„ DI ã®è² æ‹…ã¯ã‚ã¾ã‚Šå¢—ãˆã¾ã›ã‚“ã€‚

## DI Containerã®å®Ÿè£…ã«ã¤ã„ã¦

ä»¥ä¸‹ã€DI Container ã®å®Ÿè£…ã«ã¤ã„ã¦ã®èª¬æ˜ã§ã™ã€‚
ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹æ–¹ã®ã¿èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚

### ã–ã£ãã‚Šã‚„ã‚‹ã¹ãã“ã¨

DI Container ã‚’å®Ÿè£…ã™ã‚‹æ™‚ã«ã‚„ã‚‹ã“ã¨

1. DI Container ã‚’ä½œæˆã™ã‚‹ã€‚
2. DI Container ã¸ã®ç™»éŒ²æ™‚ã€DI å¯¾è±¡ã® Interface ã‚’ä½œæˆã™ã‚‹ Function ã®å¼•æ•°ã€æˆ»ã‚Šå€¤ã‚’è¦šãˆã¦ãŠã
3. DI ã—ãŸ Interface ã‚’å‘¼ã³å‡ºã™éš›ã€Interface ã®ä½œæˆã«å¿…è¦ãªå¼•æ•° Interface ã‚’ä½œæˆã—ã€å¯¾è±¡ã® Interface ã‚’ä½œæˆã™ã‚‹
   1. å‘¼ã³å‡ºã™ Interface ã®ä½œæˆã«å¿…è¦ãªå¼•æ•°ã® Interface ã‚’ä½œæˆã™ã‚‹éš›ã€å¼•æ•°ã¨ã—ã¦åˆ¥ã® Interface ã‚’æŒã£ã¦ã„ãŸå ´åˆã€å†èµ·çš„ã«ã“ã®å‡¦ç†ã‚’è¡Œã†ã€‚

ä»Šå›ã®å ´åˆã€Usecase Interfaceã€Repository Interface ãŒã‚ã£ã¦ã€ä¸¡æ–¹ã‚’ Container ã«ç™»éŒ²ã—ã¦ã„ã‚‹ã€‚
Usecase Interface ã«ã¯ Repository Interface ã‚’ä½œã£ã¦ã€Inject ã™ã‚‹ã€‚
Repository Interface ã«ã¯ä½œæˆã«å¿…è¦ãªå¼•æ•°ãŒãªã„ã€‚
ã‚‚ã— Repository Interface ã«å¿…è¦ãªå¼•æ•°ãŒã‚ã£ãŸå ´åˆã¯ã€ãã‚Œã‚’ä½œæˆã—ã€Repository Interface ã« Inject ã™ã‚‹ã€‚ãã®å¼•æ•°ã«ã‚‚...ã¨ã„ã†ã“ã¨ã‚’ç¹°ã‚Šè¿”ã™ã€‚

çµæœçš„ã«å…¨ã¦ DI ãŒè§£æ±ºã•ã‚ŒãŸ Usecase Interface ãŒå–å¾—ã§ãã‚‹ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚

### ä»Šå›ã®å®Ÿè£…

ã‚„ã‚‹ã¹ãã“ã¨ã¨ã€å®Ÿè£…ã—ãŸ Functionã€€ã®é–¢ä¿‚æ€§ã§ã™ã€‚

1. DI Container ã‚’ä½œæˆã™ã‚‹ - **NewContainer**
2. DI Container ã¸ã®ç™»éŒ²æ™‚ã€DI å¯¾è±¡ã® Interface ã‚’ä½œæˆã™ã‚‹ Function ã®å¼•æ•°ã€æˆ»ã‚Šå€¤ã‚’è¦šãˆã¦ãŠã - **Register**
3. DI ã—ãŸ Interface ã‚’å‘¼ã³å‡ºã™éš›ã€Interface ã®ä½œæˆã«å¿…è¦ãªå¼•æ•° Interface ã‚’ä½œæˆã—ã€å¯¾è±¡ã® Interface ã‚’ä½œæˆã™ã‚‹ - **Invoke**
   1. å‘¼ã³å‡ºã™ Interface ã®ä½œæˆã«å¿…è¦ãªå¼•æ•°ã® Interface ã‚’ä½œæˆã™ã‚‹éš›ã€å¼•æ•°ã¨ã—ã¦åˆ¥ã® Interface ã‚’æŒã£ã¦ã„ãŸå ´åˆã€å†èµ·çš„ã«ã“ã®å‡¦ç†ã‚’è¡Œã†ã€‚ - **resolve**

### å®Ÿè£…æ™‚ã«æ°—ã‚’ã¤ã‘ã‚‹ã“ã¨

ã‚‚ã—ã”è‡ªèº«ã§DI Container å®Ÿè£…ã™ã‚‹éš›ã¯ã€€Cash ã¯ãªã‚‹ã¹ãè¡Œã£ãŸæ–¹ãŒã„ã„ã§ã™ã€‚
DI Container ã¯ã©ã†ã—ã¦ã‚‚å†èµ·çš„ã«å‡¦ç†ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚ï¼ˆã‚‚ã—ã‚‚ã£ã¨ã„ã„æ„Ÿã˜ã«ã§ãã‚‹æ–¹æ³•ã‚’ã”å­˜çŸ¥ã®æ–¹ã¯ã”æ•™ç¤ºãã ã•ã„ï¼ï¼‰

## æœ€å¾Œã«

Github ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚
<https://github.com/tkyatg>

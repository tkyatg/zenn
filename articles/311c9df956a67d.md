---
title: "ã€å€‹äººé–‹ç™ºè€…å‘ã‘ã€‘Stripeã‚µãƒ–ã‚¹ã‚¯å®Ÿè£…ã‚’ä½™è¨ˆãªã‚µãƒ¼ãƒãƒ¼ä»£ã‹ã‘ãšã«å®Ÿè£…ã™ã‚‹æ–¹æ³•"
type: "tech"
topics: ["Firebase","Stripe","Subscription","Next.js","Firestore"]
published: true
emoji: "ğŸ¥¦"
published_at: 2023-01-05 12:00
---
å€‹äººé–‹ç™ºã‚’ã—ã¦ã„ã‚‹åšæœ¨ã§ã™ã€‚
æ™®æ®µã€Firebase hostingÃ—firestore ã§ã€ŒãŠé‡‘ã‚’ã‹ã‘ãšã«ã€ã‚µãƒ¼ãƒ“ã‚¹å…¬é–‹ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€æ±ºæ¸ˆã ã‘ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’æ°—ã«ã—ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ä½œã£ã¦ã„ã¾ã—ãŸã€‚

ãŸã¾ãŸã¾ã€Firestore ã¨é€£æºã—ã¦ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¸è¦ã§ã„ã„æ„Ÿã˜ã«å®Ÿè£…ã—ã¦ãã‚Œã‚‹ã¨ã„ã† Firebase Extentions ã€ŒRun Payments with Stripeã€ã«ã¤ã„ã¦ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™

## å¿…è¦ãªã‚‚ã®

Firebase
<https://firebase.google.com/?hl=ja>
Next.js
<https://nextjs.org/>
Stripe
<https://stripe.com/jp>

## ã‚„ã‚ŠãŸã„ã“ã¨

:::message
å®£ä¼å…¥ã‚Šã¾ã™
:::

â†“ä»¥ä¸‹ã®ã‚ˆã†ãªã€ï¼ˆä½œæˆä¸­ã®ï¼‰ã‚µãƒ¼ãƒ“ã‚¹ã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãªã—ã§æ±ºæ¸ˆã‚’å®Ÿè£…ã—ã¾ã—ãŸ

- å…¬é–‹å‹ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®ã‚­ãƒ£ãƒªã‚¢ç›¸è«‡Q&Aã‚µã‚¤ãƒˆï¼ˆä½œæˆä¸­ï¼‰
  - è‡ªåˆ†ã®ã‚­ãƒ£ãƒªã‚¢ã®æ‚©ã¿ã‚’æŠ•ç¨¿ã—ã¦ã€èª°ã‹ãŒãƒ‰ãƒã‚¤ã‚¹ã‚’ãã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹
  - ç›¸è«‡ã¯ç„¡æ–™ã§æŠ•ç¨¿ãƒ»é–²è¦§ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹å¯èƒ½
    - ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®é–²è¦§ã¯æœˆé¡æœ‰æ–™ä¼šå“¡ã®ã¿å¯èƒ½

### ç”»é¢ä¸Šã®æµã‚Œ

è³ªå•ã¯èª°ã§ã‚‚é–²è¦§å¯èƒ½
![image](https://storage.googleapis.com/zenn-user-upload/418ee75839bc-20230105.png)

å›ç­”ã¯æœˆé¡æœ‰æ–™ä¼šå“¡ã®ã¿é–²è¦§å¯èƒ½
![image](https://storage.googleapis.com/zenn-user-upload/71f6cea942f3-20230105.png)

ã€Œæœ‰æ–™ä¼šå“¡ã«ãªã£ã¦èª­ã‚€ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€Stripeã®èª²é‡‘ãƒšãƒ¼ã‚¸ã«é·ç§»ã™ã‚‹
![image](https://storage.googleapis.com/zenn-user-upload/811465b804a1-20230105.png)

æœˆé¡æœ‰æ–™ä¼šå“¡ã«ãªã‚‹ã¨ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é–²è¦§ãŒå¯èƒ½ã«ãªã‚‹
![image](https://storage.googleapis.com/zenn-user-upload/bc99dda99400-20230105.png)

## å‚è€ƒè¨˜äº‹

ã»ã¨ã‚“ã©ã“ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ã¾ã™ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã›ã„ã§å‹•ãã¾ã›ã‚“ï¼‰
<https://qiita.com/mogmet/items/cddc182156028c928ecf>

## ã€ŒRun Payments with Stripeã€ ã«ã¤ã„ã¦

Firebase Extentions ã®ï¼‘ã¤ã§ã€Firebase ã¨ Stripe ã‚’ç¹‹ã’ã¦ãã‚Œã‚‹ã‚‚ã®ã§ã™ã€‚
ã“ã® Extensions ã«ã‚ˆã£ã¦ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãªã—ã§ã‚µãƒ¼ãƒ“ã‚¹ã«æ±ºæ¸ˆã‚’ä»•è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãªã“ã¨ã‚’ã—ã¦ãã‚Œã¾ã™ã€‚

- Stripe ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ Firebase Authentication ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨è‡ªå‹•ã§ç´ä»˜ã‘
- Stripe ã®æ±ºæ¸ˆæƒ…å ±ã‚’ Webhook ã§ Firestore ã«ä¿å­˜

ä»Šå›ã¯ã“ã‚Œã‚’ä½¿ã£ã¦ã€ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰ Stripe ã®ã‚µãƒ–ã‚¹ã‚¯æ±ºæ¸ˆã‚’ã—ã¦ã€ã‚µãƒ–ã‚¹ã‚¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿æœ‰æ–™ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¦‹ã‚Œã‚‹ã¿ãŸã„ãªå®Ÿè£…ã®æ‰‹é †ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã€ŒRun Payments with Stripeã€ã‚’è¿½åŠ ã™ã‚‹

[ã€ŒRun Payments with Stripeã€](https://extensions.dev/extensions/stripe/firestore-stripe-payments)ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚

æ‰‹é †ã®1~3ç•ªã¯æŒ‡ç¤ºã«å¾“ã£ã¦ãƒãƒãƒãƒã—ã¦ã„ãã ã‘ã§OKã§ã™ã€‚
â€»Firebase æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’å¾“é‡èª²é‡‘ã® Blaze ã«å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

![image](https://storage.googleapis.com/zenn-user-upload/5a0ec270a40c-20230105.png)

æ‰‹é †ã®ï¼”ç•ªã®ã€ŒStripe API key with restricted accessã€ ã¯ Stripe ã® API key ã‚’è¨­å®šã—ã¾ã™ã€‚
Stripe ã® API KEY ã¯[åˆ¶é™ä»˜ãã§ç™ºè¡Œ](https://dashboard.stripe.com/apikeys)ã—ãŸæ–¹ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«è‰¯ã„ã§ã™ã€‚å¿…è¦ãªæ¨©é™ã¯ ã€ŒCustomersã€ã€ŒCheckout Sessionsã€ã€ŒCustomer portalã€ ã®æ›¸ãè¾¼ã¿æ¨©é™ã¨ ã€ŒSubscriptionsã€ ã®èª­ã¿å–ã‚Šã§ã™ã€‚

![image](https://storage.googleapis.com/zenn-user-upload/b90c13e4d1d2-20230105.png)

ç™ºè¡Œã—ãŸ API KEYã€€ã‚’ã€ŒStripe API key with restricted accessã€ã«å…¥åŠ›ã—ã¦ã€ã€Œã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½œæˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚

ä»–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§å¤§ä¸ˆå¤«ã§ã™ãŒã€å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å€¤ãŒ Firestore ã® Collection ã«ä¿å­˜ã•ã‚Œã‚‹ã®ã§ã€æ°—ã«ãªã‚‹æ–¹ã¯å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

æ›´æ–°å®Œäº†ã¾ã§5åˆ†ãã‚‰ã„ã‹ã‹ã‚Šã¾ã™ã€‚
![image](https://storage.googleapis.com/zenn-user-upload/3c5eb951e276-20230105.png)

## Firestoreã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ä¿®æ­£

ã€ŒRun Payments with Stripeã€ã§ã¯ã€ Firestore ã«æƒ…å ±ã®æ›¸ãè¾¼ã¿ã‚’è¡Œã†ã®ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®è¿½åŠ ãŒå¿…è¦ã§ã™ã€‚

è¿½åŠ ã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã¯ã€ŒFirebase Extensions > Run Payments with Stripe > ã“ã®æ‹¡å¼µæ©Ÿèƒ½ã®å‹•ä½œã€ã®ä¸­æ®µãã‚‰ã„ã«ã‚ã‚‹ã®ã§ã€ãã‚Œã‚’é©ç”¨ã—ã¦ãã ã•ã„ã€‚
â€»è¨­å®šå†…å®¹ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã‚‹ãƒ«ãƒ¼ãƒ«ãŒç•°ãªã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ã€ã”è‡ªèº«ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```json
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /customers/{uid} {
      allow read: if request.auth.uid == uid;

      match /checkout_sessions/{id} {
        allow read, write: if request.auth.uid == uid;
      }
      match /subscriptions/{id} {
        allow read: if request.auth.uid == uid;
      }
      match /payments/{id} {
        allow read: if request.auth.uid == uid;
      }
    }

    match /products/{id} {
      allow read: if true;

      match /prices/{id} {
        allow read: if true;
      }

      match /tax_rates/{id} {
        allow read: if true;
      }
    }
  }
}
```

ã“ã®æƒ…å ±ã‚’ Firestoreã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã«è¿½åŠ ã—ã¾ã™ã€‚
![image](https://storage.googleapis.com/zenn-user-upload/fb821f8feb6f-20230105.png)

## Stripe Webhookã«è¨­å®šè¿½åŠ 

æ¬¡ã« Stripe ã® [Webhooks](https://dashboard.stripe.com/webhooks) ç”»é¢ã‚’é–‹ãã€ã€Œã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã€ã‚’æŠ¼ä¸‹ã—ã¾ã™ã€‚

![image](https://storage.googleapis.com/zenn-user-upload/b9671a5bbafa-20230105.png)

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ URLã« ã€ŒFirebase Extensions > Run Payments with Stripe > ã“ã®æ‹¡å¼µæ©Ÿèƒ½ã®å‹•ä½œã€ã®ã€ŒConfigure Stripe webhooksã€€ã€ã® ï¼’ç•ªã«æ›¸ã„ã¦ã‚ã‚‹ URL ã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚
![image](https://storage.googleapis.com/zenn-user-upload/68acacb0f17f-20230105.png)

ç¶šã„ã¦ã€ã€Œãƒªãƒƒã‚¹ãƒ³ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã®é¸æŠã€ã§ã€ŒFirebase Extensions > Run Payments with Stripe > ã“ã®æ‹¡å¼µæ©Ÿèƒ½ã®å‹•ä½œã€ã®ã€ŒConfigure Stripe webhooksã€€ã€ã® 3ç•ªã«æ›¸ã„ã¦ã‚ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å…¨ã¦å…¥åŠ›ã—ã¾ã™ã€‚
![image](https://storage.googleapis.com/zenn-user-upload/3a4f7f95a08e-20230105.png)

ã€Œã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã€ã‚’æŠ¼ã—ã¦å®Œäº†ã™ã‚‹ã¨WebhookãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚
Extentionã€€ã¨ Webhook ã‚’æ¥ç¶šã™ã‚‹ãŸã‚ã«ç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒå¿…è¦ã«ãªã‚‹ã®ã§ã€ã€Œè¡¨ç¤ºã€ã‚’æŠ¼ã—ã¦å–å¾—ã—ã¾ã™ã€‚
![image](https://storage.googleapis.com/zenn-user-upload/368107a783d4-20230105.png)

## Webhook ã® Secret ã‚’ Extention ã«è¨­å®šã™ã‚‹

Extentions ã®ã€Œæ‹¡å¼µæ©Ÿèƒ½ã‚’å†æ§‹æˆã€ã‹ã‚‰ã€å…ˆã»ã©å–å¾—ã—ãŸç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚
![image](https://storage.googleapis.com/zenn-user-upload/3606e370d6d4-20230105.png)

ã€ŒStripe webhook secretã€ã«ç½²åã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè²¼ã‚Šä»˜ã‘ã¦ã€ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
![image](https://storage.googleapis.com/zenn-user-upload/44ef7a733aa3-20230105.png)

â€»è¨­å®šã®æ›´æ–°ã«5åˆ†ãã‚‰ã„ã‹ã‹ã‚Šã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã£ã¦ã€Stripe ã§å•†å“ä½œæˆã‚„ã€èª°ã‹ãŒæ±ºæ¸ˆã‚’è¡Œã£ãŸéš›ã« Extention ã‚’ä»‹ã—ã¦ Firestore ã«ä¿å­˜ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## Stripe ã§å•†å“ã‚’ä½œæˆ

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è³¼å…¥ã—ã¦ã»ã—ã„[ã‚µãƒ–ã‚¹ã‚¯å•†å“ã‚’ä½œæˆ](https://dashboard.stripe.com/products?active=true)ã—ã¾ã™ã€‚
ã‚µãƒ–ã‚¹ã‚¯ã§è²©å£²ã—ãŸã„ã®ã§ã€ç¶™ç¶šã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚

![image](https://storage.googleapis.com/zenn-user-upload/3b37e8d9db89-20230105.png)

å•†å“ä½œæˆå¾Œã¨ã€Firestore ã® Products ã«ã‚‚å•†å“ãŒé€£æºã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

![image](https://storage.googleapis.com/zenn-user-upload/ae90527ebb8c-20230105.png)

ã‚‚ã—ä½œæˆã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€Stripe ã® Webhook ã‹ã‚‰ãƒ­ã‚°ç¢ºèªå¯èƒ½ãªã®ã§ã€ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
![image](https://storage.googleapis.com/zenn-user-upload/cc0061f3fccd-20230105.png)

## ã‚«ã‚¹ã‚¿ãƒãƒ¼ãƒãƒ¼ã‚¿ãƒ«ã®æœ‰åŠ¹åŒ–

Stripeã®[ã‚«ã‚¹ã‚¿ãƒãƒ¼ãƒãƒ¼ã‚¿ãƒ«æœ‰åŠ¹åŒ–](https://dashboard.stripe.com/settings/billing/portal)ã‚’ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚
ã‚µãƒ–ã‚¹ã‚¯è§£ç´„ã¯å®Ÿè£…ã›ãšã€ã“ã¡ã‚‰ã®ãƒªãƒ³ã‚¯ã‚’æä¾›ã™ã‚‹ã ã‘ã§æ¸ˆã‚€ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![image](https://storage.googleapis.com/zenn-user-upload/d760874ee5c5-20230105.png)

## ãƒ•ãƒ­ãƒ³ãƒˆå®Ÿè£…

Next ã¨ã®ç¹‹ãã“ã¿ã‚’è¡Œã„ã¾ã™ã€‚
Firestore ã«å¿…è¦ãª Stripe ã®æƒ…å ±ã¯å…¨ã¦é€£æºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€Firestore ã¨ç¹‹ãã“ã‚€ã ã‘ã§OKã§ã™ã€‚

â€»ãƒ•ãƒ­ãƒ³ãƒˆã®å®Ÿè£…ã¯é›‘ã§ã™ã€‚ã™ã¿ã¾ã›ã‚“ã€‚

### è³¼å…¥ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ç”Ÿæˆ

Firestore ã« Checkout Session ã‚’ä½œæˆã—ã¾ã™ã€‚
collection(`customers/${uid}/checkout_sessions`)ã«æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§æƒ…å ±ã‚’æ›¸ãè¾¼ã‚€ã¨ã€Webhookã§ã€Stripeå´ã§å‡¦ç†ã‚’è¡Œãªã£ã¦ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å‡¦ç†çµæœãŒæ›¸ãè¾¼ã¾ã‚Œã¾ã™ã€‚
ã¾ãšã¯ã€Checkout Session ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ Firestore ã«ä½œæˆã—ã¾ã™ã€‚

â€»å•†å“ãŒ1ã¤ã¨ã„ã†å‰æã§å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

```ts
export async function createCheckoutSession({
  userId,
}: {
  userId: string;
}): Promise<string> {
  const db = getFirestore(app);
  // product id ã‚’å–å¾—
  const products = await getDocs(
    query(collection(db, "products"), where("active", "==", true), limit(1))
  );
  let productId = "";
  products.forEach((doc) => {
    productId = doc.id;
  });
  // products ã® price ã‚’å–å¾—
  const prices = await getDocs(
    query(
      collection(db, `products/${productId}/prices`),
      where("active", "==", true),
      limit(1)
    )
  );
  let priceId = "";
  prices.forEach((doc) => {
    priceId = doc.id;
  });

  const checkoutSession = {
    automatic_tax: true,
    mode: "subscription",
    payment_method_types: ["card"],
    line_items: [{ price: priceId, quantity: 1 }],
    success_url: window.location.origin + "/paid", // æ±ºæ¸ˆæˆåŠŸæ™‚ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ URL
  };

  const collectionRef = collection(db, `customers/${userId}/checkout_sessions`);
  const res = await addDoc(collectionRef, checkoutSession);
  return res.id;
}
```

![image](https://storage.googleapis.com/zenn-user-upload/cf9b4dad3242-20230105.png)

### å•†å“å–å¾—URL

Document ä½œæˆå¾Œã€Stripe å´ã§å‡¦ç†ãŒæˆåŠŸã™ã‚‹ã¨ Document ã«å•†å“è³¼å…¥ URL ãŒç™»éŒ²ã•ã‚Œã¾ã™ã€‚
ãã® URL ã‚’å–å¾—&ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¯¾è±¡ãƒªãƒ³ã‚¯å…ˆã«é£›ã°ã™ã¨ã€è³¼å…¥ãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã™ã€‚

:::message
Webhook ã§ URL ãŒç™»éŒ²ã•ã‚Œã‚‹ã¾ã§ã«ã¯ã‚¿ã‚¤ãƒ ãƒ©ã‚°ãŒã‚ã‚‹ã®ã§ã€åˆæœŸè¡¨ç¤ºæ™‚ã« `createCheckoutSession` ã‚’å®Ÿè¡Œã€ã€Œæœ‰æ–™ä¼šå“¡ç™»éŒ²ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã« `getPaymentUrl` ã‚’å®Ÿè¡Œã—ã¦ã€ãƒªãƒ³ã‚¯ãŒã‚ã‚Œã°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¯¾è±¡ãƒšãƒ¼ã‚¸ã«é£›ã°ã—ã¦ã„ã¾ã™ã€‚
:::

```ts
export async function getPaymentUrl({
  checkoutSessionsId,
  userId,
}: {
  checkoutSessionsId: string;
  userId: string;
}): Promise<string> {
  const db = getFirestore(app);
  const docRef = doc(
    db,
    `customers/${userId}/checkout_sessions`,
    checkoutSessionsId
  );
  const docSnap = await getDoc(docRef);
  const rslt = docSnap.data();
  return rslt?.url;
}
```

![image](https://storage.googleapis.com/zenn-user-upload/811465b804a1-20230105.png)

### èª²é‡‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚§ãƒƒã‚¯

å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœˆé¡èª²é‡‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã‚Œã°ã€`customers/${userId}/subscriptions`ã® Status ãŒ `active` ã«ãªã‚‹ã‚ˆã†ã§ã™ã€‚åˆæœŸè¡¨ç¤ºæ™‚ã«å–å¾—ã—ã¦å‡ºã—åˆ†ã‘ãŒã§ããã†ã§ã™ã€‚

```ts
export async function isMembershipUser({
  userId,
}: {
  userId: string;
}): Promise<boolean> {
  const db = getFirestore(app);

  const docs = await getDocs(
    query(
      collection(db, `customers/${userId}/subscriptions`),
      where("status", "in", ["trialing", "active"]),
      limit(1)
    )
  );
  return docs.size > 0 ? true : false;
}
```

## ã¾ã¨ã‚

Firebase ã™ã”ã„ä¾¿åˆ©ã§ã™ã‚ˆã­ã€œã€‚
æ‰‹é †ã¯å¤šã„ã§ã™ãŒã€æ±ºæ¸ˆã‚‚ç°¡å˜ã«å®Ÿè£…ã§ãã‚‹ã€‚ã€‚ã€‚ã€‚

ã€å®£ä¼ã€‘
ã€ŒSKILL SETã€ã¨ã„ã†ã€å…¬é–‹å‹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®ã‚­ãƒ£ãƒªã‚¢ç›¸è«‡Q&Aã‚µã‚¤ãƒˆã‚’é–‹ç™ºã—ã¦ãŠã‚Šã€è¿‘æ—¥ä¸­ã«ãƒªãƒªãƒ¼ã‚¹äºˆå®šã§ã™ï¼
Tiwtterã§ãŠçŸ¥ã‚‰ã›ã™ã‚‹ã®ã§ã€èˆˆå‘³ã‚ã‚‹æ–¹ã¯ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚
<https://twitter.com/takuya_web3>
